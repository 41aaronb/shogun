FILE(GLOB TARGETS_SRC RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/*.cs)
LIST(REMOVE_ITEM TARGETS_SRC Load.cs)

SET(CSHARP_FLAGS "${CMAKE_CURRENT_SOURCE_DIR}/Load.cs;/lib:${CSHARP_MODULAR_BUILD_DIR};/r:modshogun")

FOREACH(EXAMPLE_SRC ${TARGETS_SRC})
	STRING(REGEX REPLACE "(.*).cs" "\\1" EXAMPLE_NAME ${EXAMPLE_SRC})
	
	ADD_CUSTOM_COMMAND(OUTPUT ${EXAMPLE_NAME}
						COMMAND	${CSHARP_COMPILER} ${CMAKE_CURRENT_SOURCE_DIR}/${EXAMPLE_SRC} ${CSHARP_FLAGS}
						DEPENDS csharp_modular)
	LIST(APPEND CSHARP_EXAMPLES ${EXAMPLE_NAME})

	add_test(NAME csharp_modular-${EXAMPLE_NAME}
			WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
			COMMAND ${CSHARP_INTERPRETER} ${CMAKE_CURRENT_SOURCE_DIR}/${EXAMPLE_NAME}.exe)
	set_property(TEST csharp_modular-${EXAMPLE_NAME} PROPERTY
		ENVIRONMENT "MONO_PATH=${CSHARP_MODULAR_BUILD_DIR}")
ENDFOREACH()

add_custom_target(build_csharp_examples ALL
				 DEPENDS ${CSHARP_EXAMPLES}
				 COMMENT "C# examples")
